import olefile
import csv

def process_ole_file(file_path, csv_file_path, label):
    # Open the OLE file
    ole = olefile.OleFileIO(file_path)

    # Open the CSV file for writing
    with open(csv_file_path, mode='w', newline='') as csv_file:
        csv_writer = csv.writer(csv_file)

        entries = ole.listdir(streams=True, storages=True)
        print(f"Processing file: {file_path}")
        for entry in entries:
            # Print the entry path
            entry_path = '/'.join(entry)
            print(f"{entry_path}")

            # Write label as the first column of the CSV file
            print(f"Label: {label}")

            # Determine if it's a stream or a storage
            if ole.exists(entry):
                if ole.get_type(entry) == olefile.STGTY_STREAM:
                    content = ole.openstream(entry).read()

                    # Process the content into rows of 1018 columns
                    start = 0
                    magic_num = 1018
                    while start < len(content):
                        chunk = content[start:start + magic_num]  # 1017 because the first column is the label
                        if len(chunk) < magic_num:
                            chunk = chunk + b'\x00' * (magic_num - len(chunk))  # Pad with zeros

                        # Write the row with the label and chunk content
                        row = [label] + list(chunk)
                        csv_writer.writerow(row)
                        start += magic_num

    # Close the OLE file
    ole.close()

def filename(filepath): 
    parts = filepath.split('/')
    # Take the last part of the resulting list
    file_name = parts[-1]
    return file_name

# List of OLE file paths to process
ole_files = ['./excel_test1.xls', './excel_test2.xls', './excel_test3.xls', './excel_test4.xls']  # Add your file paths here
file_status_csv = "./oledata/parsed/file_status.csv"

with open(file_status_csv, mode='w', newline='') as file_status_csv_file:
    csv_writer = csv.writer(file_status_csv_file)
    label = 0
    # Process each OLE file
    for file_path in ole_files:
        # Define the output CSV file path
        csv_file_path = f"./oledata/parsed/{file_path}.csv"  # This will create a CSV file for each OLE file
        process_ole_file(file_path, csv_file_path, label)
        row = [filename(file_path) + '.csv'] + [label]
        csv_writer.writerow(row)
